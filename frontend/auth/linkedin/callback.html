<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LinkedIn OAuth Callback</title>
  </head>
  <body>
    <script>
      const API_BASE_URL = "http://localhost:8001/api";
      window.addEventListener("load", async function () {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get("code");
        const state = urlParams.get("state");
        const error = urlParams.get("error");
        const errorDescription = urlParams.get("error_description");

        if (error) {
          showError(
            `LinkedIn authentication failed: ${errorDescription || error}`
          );
          return;
        }

        if (!code) {
          showError("Authorization code not received from LinkedIn");
          return;
        }

        try {
          console.log("Processing LinkedIn OAuth callback...");

          // Send code to backend for processing
          const response = await fetch(`${API_BASE_URL}/linkedin/callback/`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              code: code,
              state: state,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            console.log("===== LINKEDIN AUTH SUCCESS =====");
            console.log("Backend response:", data);

            const authToken = data.token;
            const userData = {
              id: data.user.id,
              username: data.user.username,
              email: data.user.email,
              first_name: data.user.first_name || "",
              last_name: data.user.last_name || "",
              phone_verified: false,
              login_method: "linkedin",
            };

            console.log("Auth data received from backend");
            console.log("- authToken:", authToken);
            console.log("- userData:", userData);

            const isSignup = state && state.startsWith("signup_");

            console.log("State value:", state);
            console.log("Is signup flow:", isSignup);

            const authData = encodeURIComponent(
              JSON.stringify({
                token: authToken,
                user: userData,
              })
            );

            console.log(
              "Passing auth data via URL to frontend on port 3000..."
            );

<<<<<<< HEAD
            // Small delay to allow localStorage to persist
            setTimeout(() => {
              console.log("Redirecting to:", isSignup ? "onboarding" : "home");
              if (isSignup) {
                // Redirect to onboarding for new users (relative path, no /frontend/)
                window.location.href = "../onboarding.html";
              } else {
                // Redirect to home page for existing users
                window.location.href = "../index.html";
              }
            }, 300);
=======
            if (isSignup) {
              // Redirect to onboarding for new users
              console.log("Redirecting to onboarding...");
              window.location.href = `http://localhost:3000/onboarding.html?auth=${authData}`;
            } else {
              // Redirect to home page for existing users
              console.log("Redirecting to home page...");
              window.location.href = `http://localhost:3000/index.html?auth=${authData}`;
            }
>>>>>>> 082fbeb
          } else {
            throw new Error(data.error || "Authentication failed");
          }
        } catch (error) {
          console.error("LinkedIn callback error:", error);
          showError(`Login failed: ${error.message}`);
        }
      });

      function showError(message) {
        // Create and show error alert
        const alertDiv = document.createElement("div");
        alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #dc3545;
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-family: Arial, sans-serif;
                font-size: 14px;
                max-width: 400px;
                text-align: center;
            `;
        alertDiv.innerHTML = `
                <strong>Authentication Error</strong><br>
                ${message}<br><br>
                <button onclick="window.location.href='../../login.html'" style="
                    background: white;
                    color: #dc3545;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: bold;
                ">Back to Login</button>
            `;
        document.body.appendChild(alertDiv);
      }
    </script>
  </body>
</html>
